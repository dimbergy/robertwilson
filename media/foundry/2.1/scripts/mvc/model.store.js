!function(){var moduleFactory=function($){var module=this;$.require().script("mvc/model.list","mvc/lang.object").done(function(){var exports=function(){var same=$.Object.same;$.Class($.globalNamespace+".Model.Store",{init:function(){if(this.fullName===$.globalNamespace+".Model.Store"){return}this.sets=[];this.data={};this.namespace.bind("destroyed",this.callback("remove"));this.namespace.bind("updated",this.callback("updated"))},updated:function(ev,item){var sets=this.sets.slice(0),report=["Store - updating "];for(var i=0;i<sets.length;i++){var set=sets[i],inSet=this.filter(item,set.params)!==false,inList=set.list.get(item)[0];if(inSet&&!inList){report.push("adding to",set.params,"; ");set.list.push(item)}else if(!inSet&&inList){report.push("removing from",set.params,"; ");set.list.remove(item.id)}}},remove:function(ev,id){var idProp=this.id;if(id[idProp]!==undefined){id=id[idProp]}var item=this.data[id];if(!item){return}delete this.data[id]},id:"id",add:function(items,params){var len=items.length,i=0,item,idProp=this.id,id,added=[];for(;i<len;i++){item=items[i];id=item[idProp];if(this.data[id]){this.update(this.data[id],item)}else{added.push(this.data[id]=this.create(item))}}var sets=this.sets.slice(0),report=["Store - adding "];for(var i=0;i<sets.length;i++){var set=sets[i],itemsForSet=[];for(var j=0;j<added.length;j++){item=added[j];if(this.filter(item,set.params)!==false){itemsForSet.push(item)}}if(itemsForSet.length){report.push(itemsForSet.length,"to",set.params,"; ");set.list.push(itemsForSet)}}},update:function(currentItem,newItem){currentItem.attrs(newItem.serialize())},create:function(newItem){return newItem},has:function(params){return $.Object.subsets(params,this.sets).length},filter:function(item,params){var param,paramValue;for(var param in params){i=0;paramValue=params[param];if(paramValue!==undefined&&item[param]!==undefined&&!this._compare(param,item[param],paramValue)){return false}}},compare:{},_compare:function(prop,itemData,paramData){return same(itemData,paramData,this.compare[prop])},sort:function(items,params){$.each((params.order||[]).slice(0).reverse(),function(i,name){var split=name.split(" ");items=items.sort(function(a,b){if(split[1].toUpperCase()!=="ASC"){if(a[split[0]]<b[split[0]]){return 1}else if(a[split[0]]==b[split[0]]){return 0}else{return-1}}else{if(a[split[0]]<b[split[0]]){return-1}else if(a[split[0]]==b[split[0]]){return 0}else{return 1}}})});return items},pagination:function(items,params){var offset=parseInt(params.offset,10)||0,limit=parseInt(params.limit,10)||items.length-offset;return items.slice(offset,offset+limit)},get:function(id){return this.data[id]},findOne:function(id,success,error){if(this.data[id]){if(this.data[id].isRejected){return this.data[id]}else{var def=$.Deferred();def.resolve(this.data[id])}}else{var def=this.namespace.findOne({id:id}),self=this;def.done(function(item){self[id]=item})}def.done(success);return def},findAll:function(params,register,ready){var parentLoadedSet,self=this,list,cb=function(){ready(list)};if(typeof register==="function"){ready=register;register=false}ready=ready||function(){};for(var i=0;i<this.sets.length;i++){var set=this.sets[i];if($.Object.subset(params,set.params,this.compare)){parentLoadedSet=set;if($.Object.same(set.params,params,this.compare)){if(!set.def){var def=this.namespace.findAll(params);set.def=def;def.done(function(items){list=items;self.add(items,params);cb()})}else{list=set.list;if(set.def.isResolved()){setTimeout(cb,1)}else{set.def.done(cb)}}return set.list}}}list=new this.namespace.List;var sameSet={params:$.extend({},params),list:list};this.sets.push(sameSet);if(parentLoadedSet){if(!parentLoadedSet.def){}else if(parentLoadedSet.def.isResolved()){var items=self.findAllCached(params);list.push(items);setTimeout(cb,1)}else{parentLoadedSet.def.done(function(){var items=self.findAllCached(params);list.push(items);cb()})}}else{if(register){}else{var def=this.namespace.findAll(params);sameSet.def=def;def.done(function(items){self.add(items,params);cb()})}}setTimeout(function(){},10);return list},findAllCached:function(params){var list=[],data=this.data,item;for(var id in data){item=data[id];if(this.filter(item,params)!==false){list.push(item)}}list=this.pagination(this.sort(list,params),params);return list}},{})};exports();module.resolveWith(exports)})};dispatch("mvc/model.store").containing(moduleFactory).to("Foundry/2.1 Modules")}();