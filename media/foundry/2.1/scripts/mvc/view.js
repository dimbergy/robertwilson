!function(){var moduleFactory=function($){var module=this;var exports=function(){var toId=function(src){return src.replace(/^\/\//,"").replace(/[\/\.]/g,"_")},makeArray=$.makeArray,id=1;var $view=$.View=function(view,data,helpers,callback){if(typeof helpers==="function"){callback=helpers;helpers=undefined}var deferreds=getDeferreds(data);if(deferreds.length){var deferred=$.Deferred();deferreds.push(get(view,true));$.when.apply($,deferreds).then(function(resolved){var objs=makeArray(arguments),renderer=objs.pop()[0],result;if(isDeferred(data)){data=usefulPart(resolved)}else{for(var prop in data){if(isDeferred(data[prop])){data[prop]=usefulPart(objs.shift())}}}result=renderer(data,helpers);deferred.resolve(result);callback&&callback(result)});return deferred.promise()}else{var response,async=typeof callback==="function",deferred=get(view,async);if(async){response=deferred;deferred.done(function(renderer){callback(renderer(data,helpers))})}else{deferred.done(function(renderer){response=renderer(data,helpers)})}return response}},checkText=function(text,url){if(!text.match(/[^\s]/)){throw"$.View ERROR: There is no template or an empty template at "+url}},get=function(url,async){return $.ajax({url:url,dataType:"view",async:async})},isDeferred=function(obj){return obj&&$.isFunction(obj.always)},getDeferreds=function(data){var deferreds=[];if(isDeferred(data)){return[data]}else{for(var prop in data){if(isDeferred(data[prop])){deferreds.push(data[prop])}}}return deferreds},usefulPart=function(resolved){return $.isArray(resolved)&&resolved.length===3&&resolved[1]==="success"?resolved[0]:resolved};$.ajaxTransport("view",function(options,orig){var url=orig.url,suffix=url.match(/\.[\w\d]+$/),type,el,id,jqXHR,response=function(text){var func=type.renderer(id,text);if($view.cache){$view.cached[id]=func}return{view:func}};if(el=document.getElementById(url)){suffix="."+el.type.match(/\/(x\-)?(.+)/)[2]}if(!suffix){suffix=$view.ext;url=url+$view.ext}id=toId(url);if(url.match(/^\/\//)){var sub=url.substr(2);url=typeof steal==="undefined"?url="/"+sub:steal.root.mapJoin(sub)+""}type=$view.types[suffix];var template=$.template()[orig.url];return{send:function(headers,callback){if(template){type=$view.types["."+template.type];return callback(200,"success",response(template.content))}else if($view.cached[id]){return callback(200,"success",{view:$view.cached[id]})}else if(el){callback(200,"success",response(el.innerHTML))}else{jqXHR=$.ajax({async:orig.async,url:url,dataType:"text",error:function(){checkText("",url);callback(404)},success:function(text){checkText(text,url);callback(200,"success",response(text))}})}},abort:function(){jqXHR&&jqXHR.abort()}}});$.extend($view,{hookups:{},hookup:function(cb){var myid=++id;$view.hookups[myid]=cb;return myid},cached:{},cache:true,register:function(info){this.types["."+info.suffix]=info;if(window.steal){steal.type(info.suffix+" view js",function(options,success,error){var type=$view.types["."+options.type],id=toId(options.rootSrc+"");options.text=type.script(id,options.text);success()})}},types:{},ext:".ejs",registerScript:function(type,id,src){return"$.View.preload('"+id+"',"+$view.types["."+type].script(id,src)+");"},preload:function(id,renderer){$view.cached[id]=function(data,helpers){return renderer.call(data,data,helpers)}}});if(window.steal){steal.type("view js",function(options,success,error){var type=$view.types["."+options.type],id=toId(options.rootSrc+"");options.text="steal('"+(type.plugin||"jquery/view/"+options.type)+"').then(function($){"+"$.View.preload('"+id+"',"+options.text+");\n})";success()})}var convert,modify,isTemplate,isHTML,isDOM,getCallback,hookupView,funcs,noHookup={val:true,text:true};convert=function(func_name){var old=$.fn[func_name];$.fn[func_name]=function(){var args=makeArray(arguments),callbackNum,callback,self=this,result;if(isDeferred(args[0])){args[0].done(function(res){modify.call(self,[res],old)});return this}else if(isTemplate(args)){if(callbackNum=getCallback(args)){callback=args[callbackNum];args[callbackNum]=function(result){modify.call(self,[result],old);callback.call(self,result)};$view.apply($view,args);return this}result=$view.apply($view,args);if(!isDeferred(result)){args=[result]}else{result.done(function(res){modify.call(self,[res],old)});return this}}return noHookup[func_name]?old.apply(this,args):modify.call(this,args,old)}};modify=function(args,old){var res,stub,hooks;for(var hasHookups in $view.hookups){break}if(hasHookups&&args[0]&&isHTML(args[0])){hooks=$view.hookups;$view.hookups={};args[0]=$(args[0])}res=old.apply(this,args);if(hooks){hookupView(args[0],hooks)}return res};isTemplate=function(args){var secArgType=typeof args[1];return typeof args[0]=="string"&&(secArgType=="object"||secArgType=="function")&&!isDOM(args[1])};isDOM=function(arg){return arg.nodeType||arg.jquery};isHTML=function(arg){if(isDOM(arg)){return true}else if(typeof arg==="string"){arg=$.trim(arg);return arg.substr(0,1)==="<"&&arg.substr(arg.length-1,1)===">"&&arg.length>=3}else{return false}};getCallback=function(args){return typeof args[3]==="function"?3:typeof args[2]==="function"&&2};hookupView=function(els,hooks){var hookupEls,len,i=0,id,func;els=els.filter(function(){return this.nodeType!=3});hookupEls=els.add("[data-view-id]",els);len=hookupEls.length;for(;i<len;i++){if(hookupEls[i].getAttribute&&(id=hookupEls[i].getAttribute("data-view-id"))&&(func=hooks[id])){func(hookupEls[i],id);delete hooks[id];hookupEls[i].removeAttribute("data-view-id")}}$.extend($view.hookups,hooks)};$.fn.hookup=function(){var hooks=$view.hookups;$view.hookups={};hookupView(this,hooks);return this};$.each(["prepend","append","after","before","text","html","replaceWith","val"],function(i,func){convert(func)})};exports();module.resolveWith(exports)};dispatch("mvc/view").containing(moduleFactory).to("Foundry/2.1 Modules")}();