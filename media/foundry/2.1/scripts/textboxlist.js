!function(){var moduleFactory=function($){var module=this;var exports=function(){var KEYCODE={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,ENTER:13,ESCAPE:27,LEFT:37,RIGHT:39,SPACE:32,TAB:9,UP:38};$.require().library("mvc/controller").done(function(){$.template("textboxlist/item",'<li class="TextboxList-item"><span class="TextboxList-itemContent"><@== html @></span><a class="TextboxList-itemRemoveButton" href="javascript: void(0);"></a></li>');$.template("textboxlist/itemContent",'<@= title @><input type="hidden" name="items" value="<@= id @>"/>');$.Controller("TextboxList",{isPlugin:true,pluginName:"textboxlist",defaultOptions:{view:{item:"textboxlist/item",itemContent:"textboxlist/itemContent"},autocomplete:null,unique:true,caseSensitive:false,max:null,filter:null,"{item}":".TextboxList-item","{itemRemoveButton}":".TextboxList-itemRemoveButton","{itemContent}":".TextboxList-itemContent","{textField}":".TextboxList-textField"},implement:function(el){if(el.controller(TextboxList))return;el.implement(TextboxList,{},function(){this.click()})}},function(self){return{init:function(){self.item().each(function(){var item=$(this),itemContent=item.find(self.itemContent.selector);self.createItem({id:item.data("id")||function(){var id=$.uid("item-");item.data("id",id);return id}(),title:item.data("title")||$.trim(itemContent.text()),html:itemContent.html()})});var autocomplete=self.options.autocomplete;if(autocomplete||self.element.data("query")){$.module("textboxlist/autocomplete").done(function(){self.element.implement(TextboxList.Autocomplete,$.extend({controller:{textboxList:self}},autocomplete||{}))})}},items:{},itemsByTitle:{},getItemKey:function(title){return self.options.caseSensitive?title:title.toLowerCase()},filterItem:function(item){var options=self.options;var filterItem=options.filterItem;if($.isFunction(filterItem)){item=filterItem.call(self,item)}var items=self.itemsByTitle,newItem=false;if($._.isString(item)&&item!==""){var title=item,key=self.getItemKey(title);item=items.hasOwnProperty(key)?self.itemsByTitle[key]:function(){var item={id:$.uid("item-"),title:title,key:self.getItemKey(title)};newItem=true;return item}()}if(item.html===undefined){item.html=self.view.itemContent(true,item)}if(options.unique&&(self.items.hasOwnProperty(item.id)||newItem&&items.hasOwnProperty[item.key])){return null}return item},createItem:function(item){item.key=self.getItemKey(item.title);self.items[item.id]=item;self.itemsByTitle[item.key]=item},deleteItem:function(id){var item=self.items[id];delete self.items[id];var key=self.options.caseSensitive?item.title:item.title.toLowerCase();delete self.itemsByTitle[key]},addItem:function(item){if(item==="")return;var options=self.options;var max=options.max;if(max!==null&&self.item().length>=max)return;item=self.filterItem(item);if(!$.isPlainObject(item))return;self.createItem(item);self.view.item(item).attr("data-id",item.id).insertBefore(self.textField());return item},removeItem:function(id){self.item("[data-id="+id+"]").remove();self.deleteItem(id)},click:function(){self.textField().focus()},"{itemRemoveButton} click":function(item){self.removeItem(item.data("id"))},"{textField} keydown":function(textField,event){var keyCode=event.keyCode;textField.data("realEnterKey",keyCode==KEYCODE.ENTER);var textFieldKeydown=self.options.textFieldKeydown;$.isFunction(textFieldKeydown)&&textFieldKeydown.call(self,textField,event)},"{textField} keypress":function(textField,event){var keydownIsEnter=textField.data("realEnterKey"),keypressIsEnter=event.keyCode==KEYCODE.ENTER;textField.data("realEnterKey",keydownIsEnter&&keypressIsEnter);var item=$.trim(self.textField().val());var textFieldKeypress=self.options.textFieldKeypress;if($.isFunction(textFieldKeypress)){item=textFieldKeypress.call(self,textField,event,item)}if(item===undefined||item===null)return;switch(event.keyCode){case KEYCODE.ENTER:if(textField.data("realEnterKey")){self.addItem(item);textField.val("")}break}},"{textField} keyup":function(textField,event){var item=$.trim(self.textField().val());var textFieldKeyup=self.options.textFieldKeyup;if($.isFunction(textFieldKeyup)){item=textFieldKeyup.call(self,textField,event,item)}if(item===undefined||item===null)return;var canRemoveItemUsingBackspace="canRemoveItemUsingBackspace";switch(event.keyCode){case KEYCODE.BACKSPACE:if(item===""){if(!self[canRemoveItemUsingBackspace]){self[canRemoveItemUsingBackspace]=true}else{var prevItem=textField.prev(self.item.selector);if(prevItem.length>0){self.removeItem(prevItem.data("id"))}}}break;default:self[canRemoveItemUsingBackspace]=false;break}}}});$(document).on("click.textboxlist.data-api",'[data-provide="textboxlist"]',function(event){TextboxList.implement($(this))}).on("focus.textboxlist.data-api",'[data-provide="textboxlist"] .TextboxList-textField',function(event){TextboxList.implement($(this).parents(".TextboxList"))})});$.module("textboxlist/autocomplete",function(){var module=this;$.require().library("mvc/controller","ui/position").done(function(){$.template("textboxlist/menu",'<div class="TextboxList-autocomplete"><div class="inner"><ul class="TextboxList-menu"></ul></div></div>');$.template("textboxlist/menuItem",'<li class="TextboxList-menuItem"><@== html @></li>');$.Controller("TextboxList.Autocomplete",{defaultOptions:{view:{menu:"textboxlist/menu",menuItem:"textboxlist/menuItem"},minLength:1,limit:10,highlight:true,caseSensitive:false,exclusive:false,query:null,position:{my:"left top",at:"left bottom",collision:"none"},filterItem:null,"{menu}":".TextboxList-menu","{menuItem}":".TextboxList-menuItem"}},function(self){return{init:function(){if(!self.element.data(self.Class.fullName)){self.destroy();self.view.menu().appendTo("body").data(self.Class.fullName,true).implement(TextboxList.Autocomplete,self.options);return}self.textboxList.update({textFieldKeypress:self.textFieldKeypress,textFieldKeyup:self.textFieldKeyup});self.options.position.of=self.textboxList.element;self.initQuery()},initQuery:function(){var query=self.options.query||self.textboxList.element.data("query");if($.isUrl(query)){var url=query;self.query=function(keyword){return $.ajax(url+keyword)};return}if($.isFunction(query)){var func=query;self.query=function(keyword){return func.call(self,keyword)};return}if($.isArray(query)){var dataset=query;self.query=function(keyword){var task=$.Deferred(),keyword=keyword.toLowerCase();setTimeout(function(){var result=$.grep(dataset,function(item){return item.title.toLowerCase().indexOf(keyword)>-1});task.resolve(result)},0);return task};return}},show:function(){var textboxList=self.textboxList.element;self.element.show().css({width:textboxList.outerWidth()}).position(self.options.position);self.hidden=false},hide:function(){self.element.hide();self.menuItem().removeClass("active");self.render.reset();self.hidden=true},queries:{},populated:false,populate:function(keyword){self.populated=false;var options=self.options,key=options.caseSensitive?keyword:keyword.toLowerCase(),query=self.queries[key];var newQuery=!$.isDeferred(query),runQuery=function(){if(newQuery||!newQuery&&query.state()=="rejected"){query=self.queries[key]=self.query(keyword)}query.done(self.render(function(items){return[items,keyword]})).fail(function(){self.hide()})};if(newQuery){clearTimeout(self.queryTask);self.queryTask=setTimeout(runQuery,250)}else{runQuery()}},render:$.Enqueue(function(items,keyword){if(!$.isArray(items))return;if(items.length<1){self.hide();return}var menu=self.menu();if(menu.data("keyword")!==keyword){menu.empty();$.each(items,function(i,item){var filterItem=self.options.filterItem;if($.isFunction(filterItem)){item=filterItem.call(self,item,keyword)}if(!$.isPlainObject(item))return;var html=item.menuHtml||item.title;self.view.menuItem({html:html}).data("item",item).appendTo(menu)});menu.data("keyword",keyword)}self.show()}),getActiveMenuItem:function(){var activeMenuItem=self.menuItem(".active");if(activeMenuItem.length<1){activeMenuItem=undefined}return activeMenuItem},textFieldKeypress:function(textField,event,keyword){var onlyFromSuggestions=self.options.exclusive;if(self.hidden){return onlyFromSuggestions?null:keyword}var activeMenuItem=self.getActiveMenuItem();switch(event.keyCode){case KEYCODE.UP:self.menuItem().removeClass("active");if(!activeMenuItem){self.menuItem(":last").addClass("active")}else{activeMenuItem.prev(self.menuItem.selector).addClass("active")}break;case KEYCODE.DOWN:self.menuItem().removeClass("active");if(!activeMenuItem){self.menuItem(":first").addClass("active")}else{activeMenuItem.next(self.menuItem.selector).addClass("active")}break;case KEYCODE.ENTER:var activeMenuItem=self.getActiveMenuItem();self.hide();if(activeMenuItem){var item=activeMenuItem.data("item");return item}else if(onlyFromSuggestions){return null}break;case KEYCODE.ESCAPE:self.hide();break}return onlyFromSuggestions?null:keyword},textFieldKeyup:function(textField,event,keyword){var onlyFromSuggestions=self.options.exclusive;switch(event.keyCode){case KEYCODE.UP:case KEYCODE.DOWN:case KEYCODE.ENTER:case KEYCODE.ESCAPE:break;default:if(keyword===""||keyword.length<self.options.minLength){self.hide()}else{self.populate(keyword)}break}return onlyFromSuggestions?null:keyword},"{menuItem} click":function(menuItem){self.hide();var item=menuItem.data("item");self.textboxList.addItem(item);var textField=self.textboxList.textField().val("");setTimeout(function(){textField.focus()},150)}}});module.resolve(TextboxList.Autocomplete)})})};exports();module.resolveWith(exports)};dispatch("textboxlist").containing(moduleFactory).to("Foundry/2.1 Modules")}();