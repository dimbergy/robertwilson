!function(){var moduleFactory=function($){var module=this;$.require().library("lookup","ui/core","ui/position").template("suggest/contextmenu","suggest/contextmenu.item").done(function(){$.Controller("Foundry.Suggest",{defaults:{lookup:{inside:[],within:[],exclude:[]},keyword:{separator:" ",includeAsSuggestion:false,clearAfterSelection:true},contextMenu:{display:{format:"<@= title @>",after:500,whenFocused:true,withoutKeyword:true,persist:false,hideAfterSelection:true,position:{my:"left top",at:"left bottom",collision:"none"},css:{}},onRenderItem:function(data,type){return undefined},onSelectItem:function(data,type){},"@menu":"suggest/contextmenu","@menuItem":"suggest/contextmenu.item","{menu}":".suggest-contextmenu","{menuItemGroup}":".suggest-contextmenu-itemgroup","{menuItem}":".suggest-contextmenu-item"}}},function(self){return{init:function(){self.textField=self.element;self.dataset(self.options.lookup.inside);var contextMenu=$($.View(self.options.contextMenu["@menu"],{}));contextMenu.appendTo("body").implement("Foundry.Suggest.ContextMenu",$.extend(self.options.contextMenu,{parent:self}),function(){self.contextMenu=this})},dataset:function(dataset){if(dataset==undefined)return self.options.lookup.inside;if(!$.isArray(dataset))return;self.datamap={};$.map(dataset,function(data){self.attachMeta(data)});self.options.lookup.inside=dataset},attachMeta:function(data,customMeta){var suggestId=$.uid("suggestId_");return self.datamap[suggestId]=$.extend(true,data,{".suggestId":suggestId,".suggestType":"data",".suggestBuffer":self.buffer(data)},customMeta)},buffer:function(data){var buffer="",appendBuffer=function(value){if(typeof value==="string"||$.isNumeric(value))buffer+=value+" "};var props=self.options.lookup.within;if(props.length>0){$.each(props,function(i,prop){appendBuffer(data[prop])})}else{$.each(data,function(key,value){if(!key.match(".suggest"))appendBuffer(value)})}return $.trim(buffer)},search:function(keyword){if(keyword==undefined)keyword="";return $.lookup($.extend({},self.options.lookup,{using:keyword,within:[".suggestBuffer"]}))},populate:function(keyword){keyword=$.trimSeparators(keyword||self.textField.val(),self.options.keyword.separator);if(keyword==""&&(!self.contextMenu.options.display.withoutKeyword||self.dataset().length<1)){self.contextMenu.hide();return}var results=self.search(keyword);if(keyword!=""&&self.options.keyword.includeAsSuggestion){var data=self.attachMeta({title:keyword},{".suggestType":"user"});results.push(data)}if(results.length<1){self.contextMenu.hide(true);return}self.contextMenu.show(results)},exclude:function(suggestId){self.options.lookup.exclude.push({".suggestId":suggestId})},include:function(suggestId){self.options.lookup.exclude=$.grep(self.options.lookup.exclude,function(rule){return rule[".suggestId"]==suggestId},true)},focusin:function(textField,event){if(self.contextMenu.options.display.whenFocused){self.populate()}},focusout:function(textField,event){},keydown:function(textField,event){self.realEnterKey=event.keyCode==$.ui.keyCode.ENTER;self.contextMenu.keyboardLock=true;switch(event.keyCode){case $.ui.keyCode.UP:self.contextMenu.activate("previousItem");break;case $.ui.keyCode.DOWN:self.contextMenu.activate("nextItem");break}},keypress:function(textField,event){self.realEnterKey=self.realEnterKey&&event.keyCode==$.ui.keyCode.ENTER},keyup:function(textField,event){switch(event.keyCode){case $.ui.keyCode.ESCAPE:self.contextMenu.hide();break;case $.ui.keyCode.ENTER:if(self.realEnterKey){self.contextMenu.select()}else{self.populate()}break;default:self.populate()}}}});$.Controller("Foundry.Suggest.ContextMenu",{defaults:{}},function(self){return{init:function(){self.parent=self.options.parent;self.contextMenu=self.element;if(self.options.display.position.of==undefined)self.options.display.position.of=self.parent.textField;if(self.options.display.css.width==undefined)self.options.display.css.width=$(self.options.display.position.of).outerWidth()},show:function(dataset){self.render(dataset);self.contextMenu.show(0,function(){self.contextMenu.css(self.options.display.css).position(self.options.display.position)})},hide:function(forceHide){self.menuItem().removeClass("active");if(self.parent.restoreTextFieldFocus){self.parent.textField.focus()}if(!self.options.persist||forceHide){self.element.hide()}},render:function(dataset){var menuItemGroup=self.menuItemGroup();menuItemGroup.empty();$.each(dataset,function(i,data){var suggestId=data[".suggestId"],suggestType=data[".suggestType"];var menuItem=$(self.options.onRenderItem(data,suggestType)||$.View(self.options["@menuItem"],{data:data,title:data.title}));menuItem.addClass(suggestId).addClass("suggestType_"+suggestType).data("suggestId",suggestId).appendTo(menuItemGroup)});var itemToActivate=$(self.menuItem("."+self.lastActivatedItem)[0]||self.menuItem(".suggestType_user")[0]||self.menuItem(":first"));itemToActivate.addClass("active");self.lastActivatedItem=itemToActivate.data("suggestId")},lastActivatedItem:"null",activate:function(suggestId){var menuItem,menuItems=self.menuItem(),currentMenu=menuItems.filter(".active"),currentIndex=menuItems.index(currentMenu);switch(suggestId){case"nextItem":menuItem=menuItems.eq($.Number.rotate(currentIndex,0,menuItems.length-1,1));break;case"previousItem":menuItem=menuItems.eq($.Number.rotate(currentIndex,0,menuItems.length-1,-1));break;default:menuItem=self.menuItem("."+suggestId);break}if(menuItem.length<1)return;menuItems.removeClass("active");menuItem.addClass("active");self.lastActivatedItem=menuItem.data("suggestId");if(self.keyboardLock){var topline=self.contextMenu.scrollTop(),baseline=self.contextMenu.height()+topline,itemTop=menuItem.position().top+topline,itemBottom=itemTop+menuItem.outerHeight(true);if(itemTop<=topline||itemBottom>=baseline){menuItem[0].scrollIntoView()}}},select:function(){var menuItem=self.menuItem(".active");if(menuItem.length<1)return;var data=self.parent.datamap[menuItem.data("suggestId")];self.options.onSelectItem(data,data[".suggestType"]);if(self.parent.options.keyword.clearAfterSelection)self.parent.textField.val("");self.parent.restoreTextFieldFocus=true;if(self.options.display.hideAfterSelection)self.hide(true)},mouseover:function(){self.options.persist=true},mouseout:function(){self.options.persist=false},mousemove:function(){self.keyboardLock=false},"{menuItem} mouseover":function(menuItem){if(self.keyboardLock==false){self.activate(menuItem.data("suggestId"))}},"{menuItem} click":function(menuItem,event){self.menuItem().removeClass("active");menuItem.addClass("active");self.select()}}});module.resolve()})};dispatch("suggest").containing(moduleFactory).to("Foundry/2.1 Modules")}();