jQuery(function(d){function b(g,f,h){var i=jQuery("#kbbcode-message").val();jQuery("#kbbcode-message").val(i+" [attachment="+g+"]"+f+"[/attachment]");h.removeClass("btn-primary");h.addClass("btn-success");h.html('<i class="icon-upload"></i> '+Joomla.JText._("COM_KUNENA_EDITOR_IN_MESSAGE"));}var e=null;var a=d("<button>").addClass("btn btn-primary").html('<i class="icon-upload"></i> '+Joomla.JText._("COM_KUNENA_EDITOR_INSERT")).on("click",function(j){j.preventDefault();j.stopPropagation();var i=d(this),h=i.data();var g=0;var f=null;if(h.result!=undefined){g=h.result.data.id;f=h.result.data.filename;}else{g=h.id;f=h.name;}b(g,f,i);});var c=d("<button/>").addClass("btn btn-danger").attr("type","button").html('<i class="icon-trash"></i> '+Joomla.JText._("COM_KUNENA_GEN_REMOVE_FILE")).on("click",function(){var h=d(this),g=h.data();d("#klabel_info_drop_browse").show();var f=0;if(g.uploaded==true){if(g.result!=false){f=g.result.data.id;}else{f=g.file_id;}}if(jQuery("#kattachs-"+f).length==0){jQuery("#kattach-list").append('<input id="kattachs-'+f+'" type="hidden" name="attachments['+f+']" value="1" />');}if(jQuery("#kattach-"+f).length>0){jQuery("#kattach-"+f).remove();}e=e-1;jQuery.ajax({url:kunena_upload_files_rem+"&fil_id="+f,type:"DELETE",success:function(i){h.parent().remove();}});});d("#fileupload").fileupload({url:jQuery("#kunena_upload_files_url").val(),dataType:"json",autoUpload:true,disableImageResize:/Android(?!.*Chrome)|Opera/.test(window.navigator.userAgent),previewMaxWidth:100,previewMaxHeight:100,previewCrop:true}).bind("fileuploadsubmit",function(g,f){var h={};d.each(f.files,function(i,j){h={catid:jQuery("#kunena_upload").val(),filename:j.name,size:j.size,mime:j.type};});f.formData=h;}).bind("fileuploaddrop",function(h,g){var f=Object.keys(g.files).length+e;if(f>kunena_upload_files_maxfiles){d('<div class="alert alert-danger"><button class="close" type="button" data-dismiss="alert">×</button>'+Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_ERROR_REACHED_MAX_NUMBER_FILES")+"</div>").insertBefore(d("#files"));return false;}else{e=Object.keys(g.files).length+e;}}).bind("fileuploadchange",function(h,g){var f=Object.keys(g.files).length+e;if(f>kunena_upload_files_maxfiles){d('<div class="alert alert-danger"><button class="close" type="button" data-dismiss="alert">×</button>'+Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_ERROR_REACHED_MAX_NUMBER_FILES")+"</div>").insertBefore(d("#files"));return false;}else{e=Object.keys(g.files).length+e;}}).on("fileuploadadd",function(g,f){d("#progress .bar").css("width","0%");f.context=d("<div/>").appendTo("#files");d.each(f.files,function(h,i){var j=d("<p/>").append(d("<span/>").text(i.name));if(!h){j.append("<br>");}j.appendTo(f.context);});}).on("fileuploadprocessalways",function(j,i){var f=i.index,g=i.files[f],h=d(i.context.children()[f]);if(g.preview){h.prepend("<br>").prepend(g.preview);}if(g.error){h.append("<br>").append(d('<span class="text-danger"/>').text(g.error));}if(f+1===i.files.length){i.context.find("button.btn-primary").text(Joomla.JText._("COM_KUNENA_UPLOADED_LABEL_UPLOAD_BUTTON")).prop("disabled",!!i.files.error);}}).on("fileuploaddone",function(i,h){var g=d("<a>").attr("target","_blank").prop("href",h.result.location);h.context.find("span").wrap(g);if(h.result.success==true){jQuery("#kattach-list").append('<input id="kattachs-'+h.result.data.id+'" type="hidden" name="attachments['+h.result.data.id+']" value="1" />');jQuery("#kattach-list").append('<input id="kattach-'+h.result.data.id+'" type="hidden" name="attachment['+h.result.data.id+']" value="1" />');h.uploaded=true;h.context.append(a.clone(true).data(h));if(h.context.find("button").hasClass("btn-danger")){h.context.find("button.btn-danger").remove();}h.context.append(c.clone(true).data(h));}else{if(h.result.message){h.uploaded=false;h.context.append(c.clone(true).data(h));var f=null;d.each(h.result.data.exceptions,function(k,j){j=d('<div class="alert alert-error"/>').text(j.message);h.context.find("span").append("<br>").append(j);});}}}).on("fileuploadfail",function(g,f){d.each(f.files,function(i,j){var h=d('<span class="text-danger"/>').text("File upload failed.");d(f.context.children()[i]).append("<br>").append(h);});}).prop("disabled",!d.support.fileInput).parent().addClass(d.support.fileInput?undefined:"disabled");if(d("#kmessageid").val()>0){d.ajax({type:"POST",url:kunena_upload_files_preload,async:false,dataType:"json",data:{mes_id:d("#kmessageid").val()},success:function(f){if(d.isEmptyObject(f.files)==false){e=Object.keys(f.files).length;d(f.files).each(function(h,i){var j="";if(i.image===true){j='<img src="'+i.path+'" width="100" height="100" /><br />';}else{j='<i class="icon-flag-2 icon-big"></i><br />';}var g=d("<div><p>"+j+"<span>"+i.name+"</span><br /></p></div>");f.uploaded=true;f.result=false;f.file_id=i.id;g.append(a.clone(true).data(i));g.append(c.clone(true).data(f));g.appendTo("#files");});}}});}});